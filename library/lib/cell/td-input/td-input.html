<!-- TdInput Template -->

<!-- Error Block Template -->
<ng-template #errorBlock>
  @if (showError()) {
    <div class="mt-2" aria-live="polite">
      @for (err of errors(); track err) {
        <div class="alert alert-danger py-2 mb-2" role="alert">{{ err }}</div>
      }
    </div>
  }
</ng-template>

<!-- Floating Layout -->
@if (input.layout === 'floating') {
  <div [class]="wrapClass()">
    <div class="mb-3">
      <div class="form-floating">
        @switch (input.type) {
          @case ('textarea') {
            <textarea
              [id]="domId"
              [name]="input.name"
              [class]="inputClass()"
              [placeholder]="input.placeholder"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (input)="onInputChange($event)"
              (blur)="onBlur()">
            </textarea>
          }
          @case ('select') {
            <select
              [id]="domId"
              [name]="input.name"
              [class]="inputClass()"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (change)="onSelectChange($event)"
              (blur)="onBlur()">
              @for (opt of input.options; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          }
          @default {
            <input
              [id]="domId"
              [type]="input.type"
              [name]="input.name"
              [class]="inputClass()"
              [placeholder]="input.placeholder"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (input)="onInputChange($event)"
              (blur)="onBlur()"
            />
          }
        }
        <label [for]="domId">
          @if (input.icon) {
            <td-icon [icon]="input.icon"></td-icon>&nbsp;
          }
          {{ input.label }}
        </label>
      </div>
      @if (input.type !== 'radio' && input.type !== 'checkbox' && input.type !== 'switch') {
        <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
      }
    </div>
  </div>
}

<!-- Icon Layout -->
@else if (input.layout === 'icon') {
  <div [class]="wrapClass()">
    <div class="m-2">
      @if (input.label) {
        <label [for]="domId" class="form-label">{{ input.label }}</label>
      }

      <div class="input-group">
        <span [class]="input.iconGroupClass">
          @if (input.icon) {
            <td-icon [icon]="input.icon"></td-icon>
          }
        </span>

        @switch (input.type) {
          @case ('textarea') {
            <textarea
              [id]="domId"
              [name]="input.name"
              [class]="inputClass()"
              [placeholder]="input.placeholder"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (input)="onInputChange($event)"
              (blur)="onBlur()">
            </textarea>
          }
          @case ('select') {
            <select
              [id]="domId"
              [name]="input.name"
              [class]="inputClass()"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (change)="onSelectChange($event)"
              (blur)="onBlur()">
              @for (opt of input.options; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          }
          @case ('file') {
            <input
              [id]="domId"
              type="file"
              [name]="input.name"
              [class]="inputClass()"
              [disabled]="input.disabled"
              [accept]="input.accept"
              [multiple]="input.multiple"
              [attr.aria-invalid]="showError() || null"
              (change)="onFileChange($event)"
              (blur)="onBlur()"
            />
          }
          @default {
            <input
              [id]="domId"
              [type]="input.type"
              [name]="input.name"
              [class]="inputClass()"
              [placeholder]="input.placeholder"
              [disabled]="input.disabled"
              [value]="stringValue"
              [attr.aria-invalid]="showError() || null"
              (input)="onInputChange($event)"
              (blur)="onBlur()"
            />
          }
        }
      </div>

      @if (input.type !== 'radio' && input.type !== 'checkbox' && input.type !== 'switch') {
        <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
      }
    </div>
  </div>
}

<!-- Default Text Layout -->
@else {
  <div [class]="wrapClass()">
    <div class="mb-3">
      <!-- Label for standard inputs -->
      @if (input.label && ['text', 'textarea', 'number', 'email', 'password', 'date', 'datetime-local', 'time', 'file', 'canvas', 'select', 'multiselect'].includes(input.type)) {
        <label [for]="domId" class="form-label">{{ input.label }}</label>
      }

      <!-- Input Type Switch -->
      @switch (input.type) {
        <!-- Textarea -->
        @case ('textarea') {
          <textarea
            [id]="domId"
            [name]="input.name"
            [class]="inputClass()"
            [placeholder]="input.placeholder"
            [disabled]="input.disabled"
            [value]="stringValue"
            [attr.aria-invalid]="showError() || null"
            (input)="onInputChange($event)"
            (blur)="onBlur()">
          </textarea>
        }

        <!-- Select -->
        @case ('select') {
          <select
            [id]="domId"
            [name]="input.name"
            [class]="inputClass()"
            [disabled]="input.disabled"
            [value]="stringValue"
            [attr.aria-invalid]="showError() || null"
            (change)="onSelectChange($event)"
            (blur)="onBlur()">
            @for (opt of input.options; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
        }

        <!-- Multiselect (Native) -->
        @case ('multiselect') {
          @if (!input.searchable) {
            <select
              [id]="domId"
              [name]="input.name"
              [class]="inputClass()"
              [disabled]="input.disabled"
              [attr.aria-invalid]="showError() || null"
              [size]="input.size || 4"
              multiple
              (change)="onSelectChange($event)"
              (blur)="onBlur()">
              @for (opt of input.options; track opt.value) {
                <option [value]="opt.value" [selected]="arrayValue.includes(opt.value)">{{ opt.label }}</option>
              }
            </select>
          } @else {
            <!-- Searchable Multiselect -->
            <div class="position-relative w-100">
              <input
                [id]="domId"
                type="text"
                [name]="input.name"
                [class]="inputClass()"
                [placeholder]="input.placeholder"
                [disabled]="input.disabled"
                [value]="msDisplayText()"
                readonly
                [attr.aria-invalid]="showError() || null"
                (click)="onMsInputClick()"
                (focus)="onMsInputClick()"
                (blur)="onBlur()"
              />

              @if (msOpen() && !input.disabled) {
                <div class="dropdown-menu show w-100 p-2 shadow" style="max-height: 320px; overflow: auto;">
                  <input
                    type="text"
                    class="form-control mb-2"
                    [value]="msQuery()"
                    placeholder="Search..."
                    (input)="onMsSearchChange($event)"
                  />

                  @if (msFilteredOptions().length === 0) {
                    <div class="text-muted small px-2 py-2">No results</div>
                  } @else {
                    <div class="list-group">
                      @for (opt of msFilteredOptions(); track opt.value) {
                        <button
                          type="button"
                          class="list-group-item list-group-item-action d-flex align-items-center gap-2"
                          (mousedown)="$event.preventDefault()"
                          (click)="onMsToggle(opt)">
                          <input
                            class="form-check-input m-0"
                            type="checkbox"
                            [checked]="isOptionSelected(opt)"
                            readonly
                          />
                          <span class="flex-grow-1">{{ opt.label }}</span>
                        </button>
                      }
                    </div>
                  }

                  <div class="d-flex justify-content-between mt-2">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary"
                      (mousedown)="$event.preventDefault()"
                      (click)="onMsClear()">
                      Clear
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      (mousedown)="$event.preventDefault()"
                      (click)="onMsClose()">
                      Done
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        }

        <!-- Radio Group -->
        @case ('radio') {
          <fieldset>
            @if (input.label) {
              <legend class="form-label d-block mb-2 fs-6 fw-normal">{{ input.label }}</legend>
            }
            @for (opt of input.options; track opt.value; let i = $index) {
              <div class="form-check">
                <input
                  type="radio"
                  [id]="domId + '_' + i"
                  class="form-check-input"
                  [class.is-invalid]="showError()"
                  [name]="input.name"
                  [value]="opt.value"
                  [checked]="isChecked(opt.value)"
                  [disabled]="input.disabled"
                  [attr.aria-invalid]="showError() || null"
                  (change)="onInputChange($event)"
                  (blur)="onBlur()"
                />
                <label class="form-check-label" [for]="domId + '_' + i">{{ opt.label }}</label>
              </div>
            }
            <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
          </fieldset>
        }

        <!-- Checkbox Group -->
        @case ('checkbox') {
          <fieldset>
            @if (input.label) {
              <legend class="form-label d-block mb-2 fs-6 fw-normal">{{ input.label }}</legend>
            }
            @for (opt of input.options; track opt.value; let i = $index) {
              <div class="form-check">
                <input
                  type="checkbox"
                  [id]="domId + '_' + i"
                  class="form-check-input"
                  [class.is-invalid]="showError()"
                  [name]="input.name"
                  [value]="opt.value"
                  [checked]="isChecked(opt.value)"
                  [disabled]="input.disabled"
                  [attr.aria-invalid]="showError() || null"
                  (change)="onInputChange($event)"
                  (blur)="onBlur()"
                />
                <label class="form-check-label" [for]="domId + '_' + i">{{ opt.label }}</label>
              </div>
            }
            <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
          </fieldset>
        }

        <!-- Switch -->
        @case ('switch') {
          <div class="form-check form-switch">
            <input
              type="checkbox"
              role="switch"
              [id]="domId"
              class="form-check-input"
              [class.is-invalid]="showError()"
              [name]="input.name"
              [checked]="isSwitchChecked()"
              [disabled]="input.disabled"
              [attr.aria-invalid]="showError() || null"
              [attr.aria-checked]="isSwitchChecked()"
              (change)="onInputChange($event)"
              (blur)="onBlur()"
            />
            @if (input.label) {
              <label class="form-check-label" [for]="domId">{{ input.label }}</label>
            }
            <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
          </div>
        }

        <!-- File -->
        @case ('file') {
          <div>
            <input
              [id]="domId"
              type="file"
              [name]="input.name"
              [class]="inputClass()"
              [disabled]="input.disabled"
              [accept]="input.accept"
              [multiple]="input.multiple"
              [attr.aria-invalid]="showError() || null"
              (change)="onFileChange($event)"
              (blur)="onBlur()"
            />
            @if (getFilePreview()) {
              <div class="form-text mt-1 text-break">{{ getFilePreview() }}</div>
            }
            <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
          </div>
        }

        <!-- Canvas -->
        @case ('canvas') {
          <div>
            <canvas
              #canvasEl
              [id]="domId"
              [attr.name]="input.name"
              [width]="input.width"
              [height]="input.height"
              [tabIndex]="input.disabled ? -1 : 0"
              [style.width]="'100%'"
              [style.maxWidth]="'100%'"
              [style.border]="'1px solid #ced4da'"
              [style.borderRadius]="'0.375rem'"
              [style.touchAction]="'none'"
              [style.cursor]="input.disabled ? 'not-allowed' : 'crosshair'"
              [style.opacity]="input.disabled ? 0.6 : 1"
              [attr.aria-invalid]="showError() || null"
              (mousedown)="onCanvasStart($event)"
              (mousemove)="onCanvasMove($event)"
              (mouseup)="onCanvasEnd()"
              (mouseleave)="onCanvasEnd()"
              (touchstart)="onCanvasStart($event)"
              (touchmove)="onCanvasMove($event)"
              (touchend)="onCanvasEnd()"
              (blur)="onBlur()">
            </canvas>

            @if (!input.disabled) {
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearCanvas()">
                  Clear
                </button>
              </div>
            }

            <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
          </div>
        }

        <!-- Default: text-like inputs -->
        @default {
          <input
            [id]="domId"
            [type]="input.type"
            [name]="input.name"
            [class]="inputClass()"
            [placeholder]="input.placeholder"
            [disabled]="input.disabled"
            [value]="stringValue"
            [attr.min]="input.min"
            [attr.max]="input.max"
            [attr.aria-invalid]="showError() || null"
            (input)="onInputChange($event)"
            (blur)="onBlur()"
          />
        }
      }

      <!-- Error block for non-special types -->
      @if (input.type !== 'radio' && input.type !== 'checkbox' && input.type !== 'switch') {
        <ng-container *ngTemplateOutlet="errorBlock"></ng-container>
      }
    </div>
  </div>
}
