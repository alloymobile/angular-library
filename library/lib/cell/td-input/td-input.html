<!-- src/app/lib/cell/td-input/td-input.html -->

@if (model.layout === 'floating') {

  @if (model.type === 'switch') {
    <div class="mb-3">
      <div class="form-check form-switch">
        <input
          type="checkbox"
          class="form-check-input"
          [id]="model.id"
          [name]="model.name"
          [checked]="!!val"
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          (change)="onSwitchToggle($event)"
          (blur)="onBlur()"
        />
        <label class="form-check-label" [for]="model.id">{{ model.label }}</label>
      </div>

      @if (showError) {
        <div class="mt-2" aria-live="polite">
          @for (msg of combinedErrors; track $index) {
            <div class="alert alert-danger py-2 mb-2" role="alert">{{ msg }}</div>
          }
        </div>
      }
    </div>
  } @else {
    <div class="mb-3">
      <div class="form-floating">
        @switch (model.type) {

          @case ('textarea') {
            <textarea
              [id]="model.id"
              [name]="model.name"
              [placeholder]="model.placeholder"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              [ngClass]="withInvalid(model.className)"
              [(ngModel)]="val"
              (ngModelChange)="onTextLikeChange($event)"
              (blur)="onBlur()"
            ></textarea>
          }

          @case ('select') {
            <select
              [id]="model.id"
              [name]="model.name"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              [ngClass]="withInvalid(model.className)"
              [ngModel]="val"
              (ngModelChange)="onSelectChange($event)"
              (blur)="onBlur()"
            >
              @for (o of model.options; track o.value) {
                <option [value]="o.value">{{ o.label }}</option>
              }
            </select>
          }

          @case ('multiselect') {
            <select
              [id]="model.id"
              [name]="model.name"
              multiple
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              [ngClass]="withInvalid(model.className)"
              (change)="onMultiSelectChange($event)"
              (blur)="onBlur()"
            >
              @for (o of model.options; track o.value) {
                <option [value]="o.value" [selected]="isArray(val) && val.includes(o.value)">{{ o.label }}</option>
              }
            </select>
          }

          @case ('file') {
            <input
              [id]="model.id"
              [name]="model.name"
              type="file"
              [accept]="model.accept || null"
              [multiple]="!!model.multiple"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              [ngClass]="withInvalid(model.className)"
              (change)="onFileChange($event)"
              (blur)="onBlur()"
            />
          }

          @case ('canvas') {
            <div>
              <canvas
                #canvasRef
                [attr.width]="canvasWidth"
                [attr.height]="canvasHeight"
                class="td-canvas"
                [class.td-canvas-disabled]="disabled"
                (pointerdown)="onCanvasPointerDown($event)"
                (pointermove)="onCanvasPointerMove($event)"
                (pointerup)="onCanvasPointerUp($event)"
                (pointercancel)="onCanvasPointerUp($event)"
                (pointerleave)="onCanvasPointerUp($event)"
              ></canvas>

              @if (!disabled) {
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearCanvas()">Clear</button>
                </div>
              }
            </div>
          }

          @default {
            <input
              [id]="model.id"
              [name]="model.name"
              [type]="model.type"
              [placeholder]="model.placeholder"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              [ngClass]="withInvalid(model.className)"
              [(ngModel)]="val"
              (ngModelChange)="onTextLikeChange($event)"
              (blur)="onBlur()"
            />
          }
        }

        <label [for]="model.id">
          @if (iconForLabel) {
            <td-icon [icon]="iconForLabel"></td-icon>&nbsp;
          }
          {{ model.label }}
        </label>
      </div>

      @if (showError) {
        <div class="mt-2" aria-live="polite">
          @for (msg of combinedErrors; track $index) {
            <div class="alert alert-danger py-2 mb-2" role="alert">{{ msg }}</div>
          }
        </div>
      }
    </div>
  }

} @else if (model.layout === 'icon') {

  <div class="m-2">
    @if (model.label) {
      <label class="form-label" [for]="model.id">{{ model.label }}</label>
    }

    <div class="input-group">
      <span [class]="model.iconGroupClass">
        <td-icon [icon]="model.icon!"></td-icon>
      </span>

      @switch (model.type) {

        @case ('textarea') {
          <textarea
            [id]="model.id"
            [name]="model.name"
            [placeholder]="model.placeholder"
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            [ngClass]="withInvalid(model.className)"
            [(ngModel)]="val"
            (ngModelChange)="onTextLikeChange($event)"
            (blur)="onBlur()"
          ></textarea>
        }

        @case ('select') {
          <select
            [id]="model.id"
            [name]="model.name"
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            [ngClass]="withInvalid(model.className)"
            [ngModel]="val"
            (ngModelChange)="onSelectChange($event)"
            (blur)="onBlur()"
          >
            @for (o of model.options; track o.value) {
              <option [value]="o.value">{{ o.label }}</option>
            }
          </select>
        }

        @case ('multiselect') {
          <select
            [id]="model.id"
            [name]="model.name"
            multiple
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            [ngClass]="withInvalid(model.className)"
            (change)="onMultiSelectChange($event)"
            (blur)="onBlur()"
          >
            @for (o of model.options; track o.value) {
              <option [value]="o.value" [selected]="isArray(val) && val.includes(o.value)">{{ o.label }}</option>
            }
          </select>
        }

        @case ('file') {
          <input
            [id]="model.id"
            [name]="model.name"
            type="file"
            [accept]="model.accept || null"
            [multiple]="!!model.multiple"
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            [ngClass]="withInvalid(model.className)"
            (change)="onFileChange($event)"
            (blur)="onBlur()"
          />
        }

        @case ('canvas') {
          <div class="w-100">
            <canvas
              #canvasRef
              [attr.width]="canvasWidth"
              [attr.height]="canvasHeight"
              class="td-canvas"
              [class.td-canvas-disabled]="disabled"
              (pointerdown)="onCanvasPointerDown($event)"
              (pointermove)="onCanvasPointerMove($event)"
              (pointerup)="onCanvasPointerUp($event)"
              (pointercancel)="onCanvasPointerUp($event)"
              (pointerleave)="onCanvasPointerUp($event)"
            ></canvas>

            @if (!disabled) {
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearCanvas()">Clear</button>
              </div>
            }
          </div>
        }

        @case ('switch') {
          <div class="form-check form-switch ms-2 mt-1">
            <input
              type="checkbox"
              class="form-check-input"
              [id]="model.id"
              [name]="model.name"
              [checked]="!!val"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              (change)="onSwitchToggle($event)"
              (blur)="onBlur()"
            />
            <label class="form-check-label" [for]="model.id">{{ model.label }}</label>
          </div>
        }

        @default {
          <input
            [id]="model.id"
            [name]="model.name"
            [type]="model.type"
            [placeholder]="model.placeholder"
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            [ngClass]="withInvalid(model.className)"
            [(ngModel)]="val"
            (ngModelChange)="onTextLikeChange($event)"
            (blur)="onBlur()"
          />
        }
      }
    </div>

    @if (model.type === 'file') {
      @if (uploading) {
        <div class="form-text mt-1">Uploading...</div>
      }
      @if (!uploading && val && (val + '') === val) {
        <div class="form-text mt-1 text-break">{{ val }}</div>
      }
    }

    @if (showError) {
      <div class="mt-2" aria-live="polite">
        @for (msg of combinedErrors; track $index) {
          <div class="alert alert-danger py-2 mb-2" role="alert">{{ msg }}</div>
        }
      </div>
    }

    @if (model.type === 'radio') {
      <div class="mt-2">
        @if (model.label) { <label class="form-label d-block mb-2">{{ model.label }}</label> }
        @for (o of model.options; track o.value; let i = $index) {
          <div class="form-check">
            <input
              type="radio"
              class="form-check-input"
              [id]="model.id + '_' + i"
              [name]="model.name"
              [value]="o.value"
              [checked]="val === o.value"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              (change)="onRadioChange(o.value)"
              (blur)="onBlur()"
            />
            <label class="form-check-label" [for]="model.id + '_' + i">{{ o.label }}</label>
          </div>
        }
      </div>
    }

    @if (model.type === 'checkbox') {
      <div class="mt-2">
        @if (model.label) { <label class="form-label d-block mb-2">{{ model.label }}</label> }
        @for (o of model.options; track o.value; let i = $index) {
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [id]="model.id + '_' + i"
              [name]="model.name"
              [value]="o.value"
              [checked]="isArray(val) && val.includes(o.value)"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              (change)="onCheckboxToggle(o.value)"
              (blur)="onBlur()"
            />
            <label class="form-check-label" [for]="model.id + '_' + i">{{ o.label }}</label>
          </div>
        }
      </div>
    }
  </div>

} @else {

  <div class="mb-3">
    @if (model.label && (model.type === 'text' || model.type === 'textarea' || model.type === 'number' || model.type === 'email' || model.type === 'password' || model.type === 'date' || model.type === 'file' || model.type === 'canvas' || model.type === 'select' || model.type === 'multiselect')) {
      <label class="form-label" [for]="model.id">{{ model.label }}</label>
    }

    @switch (model.type) {

      @case ('textarea') {
        <textarea
          [id]="model.id"
          [name]="model.name"
          [placeholder]="model.placeholder"
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          [ngClass]="withInvalid(model.className)"
          [(ngModel)]="val"
          (ngModelChange)="onTextLikeChange($event)"
          (blur)="onBlur()"
        ></textarea>
      }

      @case ('select') {
        <select
          [id]="model.id"
          [name]="model.name"
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          [ngClass]="withInvalid(model.className)"
          [ngModel]="val"
          (ngModelChange)="onSelectChange($event)"
          (blur)="onBlur()"
        >
          @for (o of model.options; track o.value) {
            <option [value]="o.value">{{ o.label }}</option>
          }
        </select>
      }

      @case ('multiselect') {
        <select
          [id]="model.id"
          [name]="model.name"
          multiple
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          [ngClass]="withInvalid(model.className)"
          (change)="onMultiSelectChange($event)"
          (blur)="onBlur()"
        >
          @for (o of model.options; track o.value) {
            <option [value]="o.value" [selected]="isArray(val) && val.includes(o.value)">{{ o.label }}</option>
          }
        </select>
      }

      @case ('radio') {
        @if (model.label) { <label class="form-label d-block mb-2">{{ model.label }}</label> }
        @for (o of model.options; track o.value; let i = $index) {
          <div class="form-check">
            <input
              type="radio"
              class="form-check-input"
              [id]="model.id + '_' + i"
              [name]="model.name"
              [value]="o.value"
              [checked]="val === o.value"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              (change)="onRadioChange(o.value)"
              (blur)="onBlur()"
            />
            <label class="form-check-label" [for]="model.id + '_' + i">{{ o.label }}</label>
          </div>
        }
      }

      @case ('checkbox') {
        @if (model.label) { <label class="form-label d-block mb-2">{{ model.label }}</label> }
        @for (o of model.options; track o.value; let i = $index) {
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [id]="model.id + '_' + i"
              [name]="model.name"
              [value]="o.value"
              [checked]="isArray(val) && val.includes(o.value)"
              [disabled]="disabled"
              [attr.aria-invalid]="showError ? true : null"
              (change)="onCheckboxToggle(o.value)"
              (blur)="onBlur()"
            />
            <label class="form-check-label" [for]="model.id + '_' + i">{{ o.label }}</label>
          </div>
        }
      }

      @case ('switch') {
        <div class="form-check form-switch">
          <input
            type="checkbox"
            class="form-check-input"
            [id]="model.id"
            [name]="model.name"
            [checked]="!!val"
            [disabled]="disabled"
            [attr.aria-invalid]="showError ? true : null"
            (change)="onSwitchToggle($event)"
            (blur)="onBlur()"
          />
          <label class="form-check-label" [for]="model.id">{{ model.label }}</label>
        </div>
      }

      @case ('file') {
        <input
          [id]="model.id"
          [name]="model.name"
          type="file"
          [accept]="model.accept || null"
          [multiple]="!!model.multiple"
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          [ngClass]="withInvalid(model.className)"
          (change)="onFileChange($event)"
          (blur)="onBlur()"
        />
        @if (uploading) {
          <div class="form-text mt-1">Uploading...</div>
        }
        @if (!uploading && val && (val + '') === val) {
          <div class="form-text mt-1 text-break">{{ val }}</div>
        }
      }

      @case ('canvas') {
        <canvas
          #canvasRef
          [attr.width]="canvasWidth"
          [attr.height]="canvasHeight"
          class="td-canvas"
          [class.td-canvas-disabled]="disabled"
          (pointerdown)="onCanvasPointerDown($event)"
          (pointermove)="onCanvasPointerMove($event)"
          (pointerup)="onCanvasPointerUp($event)"
          (pointercancel)="onCanvasPointerUp($event)"
          (pointerleave)="onCanvasPointerUp($event)"
        ></canvas>

        @if (!disabled) {
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearCanvas()">Clear</button>
          </div>
        }
      }

      @default {
        <input
          [id]="model.id"
          [name]="model.name"
          [type]="model.type"
          [placeholder]="model.placeholder"
          [disabled]="disabled"
          [attr.aria-invalid]="showError ? true : null"
          [ngClass]="withInvalid(model.className)"
          [(ngModel)]="val"
          (ngModelChange)="onTextLikeChange($event)"
          (blur)="onBlur()"
        />
      }
    }

    @if (showError) {
      <div class="mt-2" aria-live="polite">
        @for (msg of combinedErrors; track $index) {
          <div class="alert alert-danger py-2 mb-2" role="alert">{{ msg }}</div>
        }
      </div>
    }
  </div>

}
