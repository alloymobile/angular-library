-- ============================================================================
-- ULOC and ILOC MVP 1 - IBM DB2 Database Scripts
-- Script: 99_ROLLBACK_DROP_ALL.sql
-- Purpose: Drop all objects (USE WITH EXTREME CAUTION!)
-- Author: Database Administrator
-- Created: 2026-01-26
-- WARNING: This script will DELETE ALL DATA and objects!
-- ============================================================================

SET CURRENT SCHEMA = 'RATEMGMT';

-- ============================================================================
-- STEP 1: DROP VIEWS (No dependencies)
-- ============================================================================
DROP VIEW VW_CURRENT_PRIME_RATE;
DROP VIEW VW_PRIME_RATE_HISTORY;
DROP VIEW VW_NOTIFICATION_STATUS;
DROP VIEW VW_RATE_SUMMARY_STATS;
DROP VIEW VW_RATE_AUDIT_TRAIL;
DROP VIEW VW_WORKFLOW_HISTORY;
DROP VIEW VW_PENDING_APPROVALS;
DROP VIEW VW_ULOC_EXPIRING_RATES;
DROP VIEW VW_ILOC_EXPIRING_RATES;
DROP VIEW VW_ULOC_CURRENT_RATES;
DROP VIEW VW_ILOC_CURRENT_RATES;
DROP VIEW VW_ULOC_RATES_ALL;
DROP VIEW VW_ILOC_RATES_ALL;
DROP VIEW VW_AMOUNT_TIERS_BY_PRODUCT;
DROP VIEW VW_ACTIVE_PRODUCT_HIERARCHY;
DROP VIEW VW_PRODUCT_HIERARCHY;

-- ============================================================================
-- STEP 2: DROP FOREIGN KEYS (Before dropping tables)
-- ============================================================================

-- ULOC History FKs
ALTER TABLE RATE_ULOC_HISTORY DROP CONSTRAINT FK_ULOC_HST_WORKFLOW;
ALTER TABLE RATE_ULOC_HISTORY DROP CONSTRAINT FK_ULOC_HST_NOTIF;
ALTER TABLE RATE_ULOC_HISTORY DROP CONSTRAINT FK_ULOC_HST_TIER;
ALTER TABLE RATE_ULOC_HISTORY DROP CONSTRAINT FK_ULOC_HST_CVP;

-- ULOC Active FKs
ALTER TABLE RATE_ULOC_ACTIVE DROP CONSTRAINT FK_ULOC_ACT_WORKFLOW;
ALTER TABLE RATE_ULOC_ACTIVE DROP CONSTRAINT FK_ULOC_ACT_NOTIF;
ALTER TABLE RATE_ULOC_ACTIVE DROP CONSTRAINT FK_ULOC_ACT_TIER;
ALTER TABLE RATE_ULOC_ACTIVE DROP CONSTRAINT FK_ULOC_ACT_CVP;

-- ULOC Draft FKs
ALTER TABLE RATE_ULOC_DRAFT DROP CONSTRAINT FK_ULOC_DRF_WORKFLOW;
ALTER TABLE RATE_ULOC_DRAFT DROP CONSTRAINT FK_ULOC_DRF_NOTIF;
ALTER TABLE RATE_ULOC_DRAFT DROP CONSTRAINT FK_ULOC_DRF_TIER;
ALTER TABLE RATE_ULOC_DRAFT DROP CONSTRAINT FK_ULOC_DRF_CVP;

-- ILOC History FKs
ALTER TABLE RATE_ILOC_HISTORY DROP CONSTRAINT FK_ILOC_HST_WORKFLOW;
ALTER TABLE RATE_ILOC_HISTORY DROP CONSTRAINT FK_ILOC_HST_NOTIF;
ALTER TABLE RATE_ILOC_HISTORY DROP CONSTRAINT FK_ILOC_HST_SUBCAT;
ALTER TABLE RATE_ILOC_HISTORY DROP CONSTRAINT FK_ILOC_HST_TIER;

-- ILOC Active FKs
ALTER TABLE RATE_ILOC_ACTIVE DROP CONSTRAINT FK_ILOC_ACT_WORKFLOW;
ALTER TABLE RATE_ILOC_ACTIVE DROP CONSTRAINT FK_ILOC_ACT_NOTIF;
ALTER TABLE RATE_ILOC_ACTIVE DROP CONSTRAINT FK_ILOC_ACT_SUBCAT;
ALTER TABLE RATE_ILOC_ACTIVE DROP CONSTRAINT FK_ILOC_ACT_TIER;

-- ILOC Draft FKs
ALTER TABLE RATE_ILOC_DRAFT DROP CONSTRAINT FK_ILOC_DRF_WORKFLOW;
ALTER TABLE RATE_ILOC_DRAFT DROP CONSTRAINT FK_ILOC_DRF_NOTIF;
ALTER TABLE RATE_ILOC_DRAFT DROP CONSTRAINT FK_ILOC_DRF_SUBCAT;
ALTER TABLE RATE_ILOC_DRAFT DROP CONSTRAINT FK_ILOC_DRF_TIER;

-- Master Table FKs
ALTER TABLE AMOUNT_TIER DROP CONSTRAINT FK_TIER_PRODUCT;
ALTER TABLE CVP_CODE DROP CONSTRAINT FK_CVP_SUBCATEGORY;
ALTER TABLE SUB_CATEGORY DROP CONSTRAINT FK_SUBCAT_CATEGORY;
ALTER TABLE CATEGORY DROP CONSTRAINT FK_CATEGORY_PRODUCT;

-- ============================================================================
-- STEP 3: DROP RATE TABLES
-- ============================================================================
DROP TABLE RATE_ULOC_HISTORY;
DROP TABLE RATE_ULOC_ACTIVE;
DROP TABLE RATE_ULOC_DRAFT;
DROP TABLE RATE_ILOC_HISTORY;
DROP TABLE RATE_ILOC_ACTIVE;
DROP TABLE RATE_ILOC_DRAFT;

-- ============================================================================
-- STEP 4: DROP MASTER TABLES (In reverse dependency order)
-- ============================================================================
DROP TABLE WORKFLOW;
DROP TABLE NOTIFICATION;
DROP TABLE CVP_CODE;
DROP TABLE SUB_CATEGORY;
DROP TABLE CATEGORY;
DROP TABLE AMOUNT_TIER;
DROP TABLE PRIME;
DROP TABLE PRODUCT;

-- ============================================================================
-- STEP 5: DROP SEQUENCES
-- ============================================================================
DROP SEQUENCE SEQ_RATE_ULOC_HISTORY_ID;
DROP SEQUENCE SEQ_RATE_ULOC_ACTIVE_ID;
DROP SEQUENCE SEQ_RATE_ULOC_DRAFT_ID;
DROP SEQUENCE SEQ_RATE_ILOC_HISTORY_ID;
DROP SEQUENCE SEQ_RATE_ILOC_ACTIVE_ID;
DROP SEQUENCE SEQ_RATE_ILOC_DRAFT_ID;
DROP SEQUENCE SEQ_WORKFLOW_ID;
DROP SEQUENCE SEQ_NOTIFICATION_ID;
DROP SEQUENCE SEQ_PRIME_ID;
DROP SEQUENCE SEQ_AMOUNT_TIER_ID;
DROP SEQUENCE SEQ_CVP_CODE_ID;
DROP SEQUENCE SEQ_SUB_CATEGORY_ID;
DROP SEQUENCE SEQ_CATEGORY_ID;
DROP SEQUENCE SEQ_PRODUCT_ID;

-- ============================================================================
-- STEP 6: DROP SCHEMA (Optional - will fail if any objects remain)
-- ============================================================================
DROP SCHEMA RATEMGMT RESTRICT;

-- ============================================================================
-- VERIFICATION
-- ============================================================================
-- Verify all objects are dropped
SELECT TABNAME FROM SYSCAT.TABLES WHERE TABSCHEMA = 'RATEMGMT';
SELECT VIEWNAME FROM SYSCAT.VIEWS WHERE VIEWSCHEMA = 'RATEMGMT';
SELECT SEQNAME FROM SYSCAT.SEQUENCES WHERE SEQSCHEMA = 'RATEMGMT';

-- ============================================================================
-- END OF ROLLBACK SCRIPT
-- ============================================================================
